name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

run-name: CI on ${{ github.head_ref || github.ref_name }}

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Detect changed files
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            code:
              - '.github/workflows/ci.yml'
              - '**/*.go'
              - 'go.mod'
              - 'go.sum'

      - name: Set up Go
        if: steps.filter.outputs.code == 'true'
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod

      - name: Run lint and format checks
        if: steps.filter.outputs.code == 'true'
        shell: bash
        run: |
          echo "Checking Go code formatting..."
          unformatted=$(gofmt -l .)
          if [ -n "$unformatted" ]; then
            echo "The following files are not formatted:"
            echo "$unformatted"
            exit 1
          fi

          echo "Running go vet..."
          go vet ./...

          echo "All lint and format checks passed!"

      - name: Build
        if: steps.filter.outputs.code == 'true'
        shell: bash
        run: |
          go build ./...

      - name: Run tests
        if: steps.filter.outputs.code == 'true'
        shell: bash
        run: |
          go test ./...

      - name: Skip CI checks (no relevant changes)
        if: steps.filter.outputs.code != 'true'
        shell: bash
        run: |
          echo "No changes detected in code-related files."
          echo "Skipping build, lint, and test steps."
          echo "CI passed successfully."
